<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

    <!-- /// META TIÊU ĐỀ & MÔ TẢ /// -->
    <title>Niyaki Pham | Profile Cá Nhân | Phát Nhạc, To-Do List & Khám Phá Anime</title>
    <meta name="description" content="Chào mừng đến với profile cá nhân của Niyaki Phạm (Phạm Văn Hoàng) - Tự động phát nhạc playlist yêu thích, quản lý công việc hiệu quả với To-Do List hẹn giờ và khám phá thế giới Anime phong phú.">
    <meta name="author" content="Niyaki Pham (Phạm Văn Hoàng)">

    <!-- /// META TỪ KHÓA SEO /// -->
    <meta name="keywords" content="Niyaki Phạm, Niyaki Pham, niyakipham, Nishima Hayashi, Hoàng Nghiền PC, Phạm Văn Hoàng, Pham Van Hoang, Phạm Văn Hoàng 2006, Phạm Văn Hoàng HP, Phạm Văn Hoàng Hải Phòng, Lập trình viên Hải Phòng, Developer Hải Phòng, Profile cá nhân, Porfolio, Web Developer, AI, Khoa học viễn tưởng, Sci-fi profile, Music Playlist, Audio Player, Autoplay music, Real-time Clock, To-Do List, Quản lý công việc, Nhắc nhở hẹn giờ, Notification API, Anime Search, Tìm kiếm Anime, Xem Anime Online">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">

    <!-- /// META CANONICAL URL /// -->
    <link rel="canonical" href="https://niyakipham.github.io/"> <!-- !! Quan trọng: Thay bằng URL chính thức của bạn !! -->

    <!-- /// META ICON (FAVICON) /// -->
    <link rel="icon" href="https://niyakipham.github.io/assets/kaguya.jpeg" type="image/jpeg">
    <link rel="apple-touch-icon" href="https://niyakipham.github.io/assets/kaguya.jpeg">

    <!-- /// META OPEN GRAPH /// -->
    <meta property="og:title" content="Niyaki Phạm (Phạm Văn Hoàng) - Profile Sci-Fi: Nhạc, To-Do & Tìm Anime">
    <meta property="og:description" content="Khám phá thế giới sáng tạo của Niyaki Phạm qua profile độc đáo: playlist nhạc tự động, To-Do list hẹn giờ và công cụ tìm kiếm, xem anime tiện lợi. Liên hệ ngay!">
    <meta property="og:type" content="profile">
    <meta property="og:url" content="https://niyakipham.github.io/"> <!-- !! Quan trọng: Thay bằng URL chính thức của bạn !! -->
    <meta property="og:image" content="https://raw.githubusercontent.com/niyakipham/assets/kaguya.jpeg">
    <meta property="og:image:alt" content="Ảnh đại diện của Niyaki Phạm">
    <meta property="og:locale" content="vi_VN">
    <meta property="profile:username" content="niyakipham">

    <!-- /// META TWITTER CARD /// -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Niyaki Phạm - Profile: Nhạc Tự Động, To-Do List & Tìm Kiếm Anime">
    <meta name="twitter:description" content="Kết nối Niyaki Phạm (Phạm Văn Hoàng / Hoàng Nghiền PC)! Nghe nhạc tự động, quản lý công việc, tìm và xem anime yêu thích ngay trên profile độc đáo này.">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/niyakipham/assets/kaguya.jpeg">
    <meta name="twitter:site" content="@niyakipham"> <!-- Thay nếu có -->
    <meta name="twitter:creator" content="@niyakipham"> <!-- Thay nếu có -->

    <!-- /// GOOGLE FONTS /// -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <!-- /// IONICONS /// -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js" defer></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js" defer></script>

    <!-- /// ANIME.JS /// -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

    <style>
        /* === CSS RESET & BASE STYLES === */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --color-bg-dark: #0a0a0a; --color-primary: #e11d48; --color-secondary: #f43f5e;
            --color-accent: #f87171; --color-text-primary: #f1f1f1; --color-text-secondary: #a1a1a1;
            --color-primary-rgb: 225, 29, 72; /* Will be set by JS */
            --color-glitch-1: #00ffff; --color-glitch-2: #ff00ff;
            --font-primary: 'Inter', sans-serif; --font-secondary: 'Orbitron', sans-serif;
            --grid-size: 30px; --grid-line-color: rgba(var(--color-primary-rgb), 0.08); --grid-line-width: 1px;
            --transition-speed-fast: 0.2s; --transition-speed-normal: 0.4s;
            --border-radius-sm: 4px; --border-radius-md: 8px; --border-radius-lg: 16px; --border-radius-circle: 50%;
            --space-xxs: 0.25rem; --space-xs: 0.5rem; --space-sm: 0.85rem;
            --space-md: 1.25rem; --space-lg: 2rem;
        }
        html { font-size: 16px; scroll-behavior: smooth; }
        body {
            font-family: var(--font-primary); color: var(--color-text-primary); background-color: var(--color-bg-dark);
            background-image: linear-gradient(to right, var(--grid-line-color) var(--grid-line-width), transparent var(--grid-line-width)), linear-gradient(to bottom, var(--grid-line-color) var(--grid-line-width), transparent var(--grid-line-width));
            background-size: var(--grid-size) var(--grid-size);
            min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: var(--space-sm);
            overflow-x: hidden; position: relative; line-height: 1.6;
        }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="4" height="4" viewBox="0 0 4 4"><path fill="%23cccccc" fill-opacity="0.02" d="M0 0h2v2H0zM2 2h2v2H0z"></path></svg>'); opacity: 0.6; pointer-events: none; z-index: -1; animation: scanlines 15s linear infinite; }
        @keyframes scanlines { 0% { background-position: 0 0; } 100% { background-position: 0 150px; } }

        /* === MAIN CONTAINER === */
        #container {
            background-color: rgba(16, 16, 16, 0.7); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--border-radius-lg);
            padding: var(--space-md); max-width: 480px; width: 100%; text-align: center;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.6), inset 0 0 20px rgba(var(--color-primary-rgb), 0.15);
            position: relative; overflow: hidden; transform-style: preserve-3d;
            opacity: 0; transform: translateY(20px); /* Animation Start */
            display: flex; flex-direction: column; gap: var(--space-sm);
        }

        /* === PROFILE SECTION === */
        #profile { position: relative; display: flex; flex-direction: column; align-items: center; }
        #profile-image-wrapper { position: relative; width: 100px; height: 100px; margin-bottom: var(--space-xs); }
        #profile-image-wrapper::before { content: ''; position: absolute; inset: -4px; border-radius: var(--border-radius-circle); background: conic-gradient(from 90deg, transparent 0%, var(--color-secondary) 25%, var(--color-primary) 50%, var(--color-secondary) 75%, transparent 100%); filter: blur(12px); z-index: -1; animation: rotateGlow 5s linear infinite; opacity: 0.7; }
        @keyframes rotateGlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #profile img#avatar { width: 100%; height: 100%; object-fit: cover; border-radius: var(--border-radius-circle); border: 2px solid var(--color-primary); padding: 2px; background-color: var(--color-bg-dark); transition: transform var(--transition-speed-normal) ease, box-shadow var(--transition-speed-normal) ease; cursor: pointer; position: relative; z-index: 1; }
        #profile img#avatar:hover { transform: scale(1.05) rotate(2deg); box-shadow: 0 0 15px var(--color-primary); }
        #profile p#username { font-weight: 500; font-size: 1.05rem; color: var(--color-text-primary); margin-top: var(--space-xxs); font-family: var(--font-secondary); letter-spacing: 1px; text-shadow: 0 0 4px var(--color-secondary), 1px 1px 1px rgba(0,0,0,0.5); margin-bottom: var(--space-xxs); }
        .glitch-text { position: relative; text-shadow: 0.05em 0 0 var(--color-glitch-1), -0.025em -0.05em 0 var(--color-glitch-2), 0.025em 0.05em 0 var(--color-glitch-1); animation: glitchAnim 0.5s infinite alternate; }
        @keyframes glitchAnim { 0%{text-shadow:.05em 0 0 var(--color-glitch-1),-.05em -.025em 0 var(--color-glitch-2),-.025em .05em 0 var(--color-glitch-1)}25%{-0.05em -0.025em 0 var(--color-glitch-1),.025em .025em 0 var(--color-glitch-2),-0.05em -0.05em 0 var(--color-glitch-1)}50%{text-shadow:.025em .05em 0 var(--color-glitch-1),.05em 0 0 var(--color-glitch-2),0 -.05em 0 var(--color-glitch-1)}75%{text-shadow:-.05em 0 0 var(--color-glitch-1),-.025em -.025em 0 var(--color-glitch-2),-.025em -.05em 0 var(--color-glitch-1)}100%{text-shadow:-.025em 0 0 var(--color-glitch-1),.025em -.025em 0 var(--color-glitch-2),.05em .05em 0 var(--color-glitch-1)} }

        /* === CLOCK STYLES === */
        #clock { font-family: var(--font-secondary); font-size: 0.85rem; color: var(--color-text-secondary); letter-spacing: 1.5px; opacity: 0; transform: translateY(10px); /* Animation */ text-shadow: 0 0 3px rgba(var(--color-primary-rgb), 0.3); margin-bottom: 0; }

        /* === TO-DO LIST STYLES === */
        #todo-section { border-top: 1px solid rgba(var(--color-primary-rgb), 0.15); padding-top: var(--space-sm); opacity: 0; transform: translateY(20px); /* Animation */ }
        .sci-fi-heading { font-family: var(--font-secondary); font-size: 1rem; color: var(--color-primary); text-align: center; margin-bottom: var(--space-xs); letter-spacing: 0.5px; text-shadow: 0 0 4px rgba(var(--color-primary-rgb), 0.4); }
        #todo-form { display: flex; flex-direction: column; gap: var(--space-xs); margin-bottom: var(--space-sm); }
        #todo-form .todo-input-group { display: flex; flex-wrap: wrap; gap: var(--space-xs); }
        #todo-form input[type="text"], #todo-form input[type="time"] { flex-grow: 1; padding: var(--space-xs) var(--space-sm); background-color: rgba(var(--color-primary-rgb), 0.05); border: 1px solid rgba(var(--color-primary-rgb), 0.25); border-radius: var(--border-radius-sm); color: var(--color-text-primary); font-family: var(--font-primary); font-size: 0.85rem; min-width: 100px; }
        #todo-form input[type="time"] { flex-basis: 100px; flex-grow: 0; appearance: none; -webkit-appearance: none; }
        #todo-form input[type="time"]::-webkit-calendar-picker-indicator { display: none; }
        #todo-form input[type="time"]::-webkit-datetime-edit-ampm-field { color: var(--color-accent); }
        #todo-form input[type="time"]::-webkit-datetime-edit-hour-field, #todo-form input[type="time"]::-webkit-datetime-edit-minute-field { color: var(--color-text-primary); }
        #todo-form input::placeholder { color: var(--color-text-secondary); opacity: 0.7; }
        #add-todo-btn, #request-permission-btn { padding: var(--space-xs) var(--space-sm); background-color: rgba(var(--color-primary-rgb), 0.2); border: 1px solid var(--color-primary); color: var(--color-primary); font-family: var(--font-secondary); font-weight: 500; font-size: 0.9rem; border-radius: var(--border-radius-sm); cursor: pointer; transition: all var(--transition-speed-fast) ease; display: inline-flex; align-items: center; justify-content: center; gap: var(--space-xxs); align-self: flex-start; height: 36px; }
        #add-todo-btn ion-icon { font-size: 1.1em; }
        #add-todo-btn:hover, #request-permission-btn:hover { background-color: var(--color-primary); color: var(--color-bg-dark); box-shadow: 0 0 8px rgba(var(--color-primary-rgb), 0.4); }
        #request-permission-btn { display: none; margin-top: var(--space-xs); }
        #todo-list { list-style: none; padding: 0; margin: 0; max-height: 160px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(var(--color-primary-rgb), 0.1); }
        #todo-list::-webkit-scrollbar { width: 5px; }
        #todo-list::-webkit-scrollbar-track { background: rgba(var(--color-primary-rgb), 0.08); border-radius: 3px;}
        #todo-list::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: 3px; border: 1px solid rgba(var(--color-primary-rgb), 0.2);}
        #todo-list li { background-color: rgba(255, 255, 255, 0.02); border-left: 3px solid var(--color-primary); padding: var(--space-xs) var(--space-sm); margin-bottom: var(--space-xs); border-radius: var(--border-radius-sm); display: flex; justify-content: space-between; align-items: center; gap: var(--space-sm); opacity: 0; transform: translateX(-10px); /* Animation */ transition: background-color var(--transition-speed-fast), opacity 0.3s ease, transform 0.3s ease, border-left-color var(--transition-speed-fast); }
        #todo-list li.completed { border-left-color: var(--color-text-secondary); opacity: 0.5; }
        #todo-list li.completed .todo-text { text-decoration: line-through; color: var(--color-text-secondary); }
        #todo-list .todo-content { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; word-break: break-word; }
        #todo-list .todo-text { color: var(--color-text-primary); font-size: 0.9rem; }
        #todo-list .todo-time-info { font-size: 0.7rem; color: var(--color-text-secondary); margin-top: 2px; display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
        #todo-list .todo-time-info ion-icon { font-size: 0.85em; }
        #todo-list .todo-time-info ion-icon[name="alarm-outline"] { color: var(--color-accent); }
        #todo-list .todo-time-info ion-icon[name="checkmark-done-outline"] { color: var(--color-primary); }
        #todo-list .todo-actions { display: flex; gap: var(--space-xxs); flex-shrink: 0; }
        #todo-list .todo-actions button { background: none; border: none; color: var(--color-text-secondary); font-size: 1.2rem; cursor: pointer; padding: 4px; border-radius: 50%; transition: color var(--transition-speed-fast), background-color var(--transition-speed-fast); display: flex; align-items: center; justify-content: center; }
        #todo-list .todo-actions button.delete-btn:hover { color: #ff4d4d; background-color: rgba(255, 77, 77, 0.1); }
        #todo-list .todo-actions button.complete-btn:hover { color: #4caf50; background-color: rgba(76, 175, 80, 0.1); }
        #todo-list li.completed .todo-actions button.complete-btn { color: #4caf50; }

        /* === AUDIO PLAYER (Simplified) === */
        #audio-player { background-color: rgba(var(--color-primary-rgb), 0.05); border: 1px solid rgba(var(--color-primary-rgb), 0.2); border-radius: var(--border-radius-md); padding: var(--space-sm); opacity: 0; transform: translateY(10px); /* Animation */ box-shadow: inset 0 1px 5px rgba(var(--color-primary-rgb), 0.1); display: flex; flex-direction: column; gap: var(--space-sm); }
        #audio-player .track-info { width: 100%; text-align: left; overflow: hidden; display: flex; flex-direction: column; gap: var(--space-xs); }
        #audio-player #track-title { display: block; font-size: 0.95rem; color: var(--color-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: var(--font-secondary); letter-spacing: 0.5px; padding: 0 var(--space-xs); min-height: 1.2em; line-height: 1.3; }
        #audio-player .progress-container { width: 100%; height: 8px; background-color: rgba(0, 0, 0, 0.3); border-radius: var(--border-radius-sm); cursor: pointer; overflow: hidden; position: relative; border: 1px solid rgba(var(--color-primary-rgb), 0.1); }
        #audio-player #progress-bar { width: 0%; height: 100%; background-color: var(--color-primary); border-radius: var(--border-radius-sm); transition: width 0.1s linear; box-shadow: 0 0 8px 1px var(--color-primary); }
        #audio-player .controls { width: 100%; display: flex; justify-content: center; /* <<< Centered */ align-items: center; gap: var(--space-md); padding: 0 var(--space-xs); }
        #audio-player .controls .main-controls { display: flex; align-items: center; gap: var(--space-md); }
        #audio-player .controls button { background: none; border: none; color: var(--color-text-secondary); font-size: 1.6rem; cursor: pointer; padding: var(--space-xs); display: flex; align-items: center; justify-content: center; transition: color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease, background-color var(--transition-speed-fast) ease; line-height: 1; border-radius: var(--border-radius-circle); }
        #audio-player .controls button:hover, #audio-player .controls button:focus { color: var(--color-secondary); transform: scale(1.1); outline: none; background-color: rgba(var(--color-primary-rgb), 0.1); }
        #audio-player .controls button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background-color: transparent; }
        #audio-player .controls button ion-icon { display: block; }
        #audio-player button#play-pause-btn { font-size: 2.4rem; color: var(--color-secondary); }
        #audio-player button#play-pause-btn:hover, #audio-player button#play-pause-btn:focus { color: var(--color-primary); background-color: rgba(var(--color-primary-rgb), 0.15); }

        /* === ANIME SEARCH SECTION STYLES === */
        #anime-search-section {
            border-top: 1px solid rgba(var(--color-primary-rgb), 0.15);
            padding-top: var(--space-sm);
            margin-top: var(--space-sm);
            opacity: 0; /* Để tạo hiệu ứng xuất hiện */
            transform: translateY(20px); /* Để tạo hiệu ứng xuất hiện */
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        #search-wrapper {
            display: flex;
            gap: var(--space-xs);
            position: relative;
        }
        #anime-search-input {
            flex-grow: 1;
            padding: var(--space-xs) var(--space-sm);
            padding-right: 40px;
            background-color: rgba(var(--color-primary-rgb), 0.05);
            border: 1px solid rgba(var(--color-primary-rgb), 0.25);
            border-radius: var(--border-radius-sm);
            color: var(--color-text-primary);
            font-family: var(--font-primary);
            font-size: 0.9rem;
            transition: border-color var(--transition-speed-fast), box-shadow var(--transition-speed-fast);
        }
        #anime-search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 8px rgba(var(--color-primary-rgb), 0.3);
        }
        #anime-search-input::placeholder {
            color: var(--color-text-secondary);
            opacity: 0.7;
        }
        #anime-search-input:disabled {
             cursor: not-allowed;
             opacity: 0.6;
        }
        #anime-search-input::-webkit-search-cancel-button,
        #anime-search-input::-webkit-search-decoration {
            -webkit-appearance: none;
            appearance: none;
        }
        #search-button {
            position: absolute;
            right: 1px;
            top: 1px;
            bottom: 1px;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 1.4rem;
            cursor: pointer;
            padding: 0 var(--space-xs);
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
            transition: color var(--transition-speed-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
         #search-button:disabled {
             cursor: not-allowed;
             opacity: 0.5;
             color: var(--color-text-secondary) !important;
         }
        #search-button:not(:disabled):hover {
            color: var(--color-primary);
        }
        #anime-results-container,
        #anime-episode-list-container {
            background-color: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(var(--color-primary-rgb), 0.1);
            border-radius: var(--border-radius-md);
            padding: var(--space-sm);
            min-height: 60px;
            max-height: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) rgba(var(--color-primary-rgb), 0.1);
            transition: all 0.3s ease;
        }
        #anime-results-container::-webkit-scrollbar,
        #anime-episode-list-container::-webkit-scrollbar { width: 5px; }
        #anime-results-container::-webkit-scrollbar-track,
        #anime-episode-list-container::-webkit-scrollbar-track { background: rgba(var(--color-primary-rgb), 0.08); border-radius: 3px;}
        #anime-results-container::-webkit-scrollbar-thumb,
        #anime-episode-list-container::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: 3px; border: 1px solid rgba(var(--color-primary-rgb), 0.2);}
        #anime-episode-list-container {
            display: none;
            flex-direction: column;
            gap: var(--space-xs);
        }
        #episode-list-heading {
            margin-bottom: var(--space-xs);
            padding-bottom: var(--space-xs);
            border-bottom: 1px dashed rgba(var(--color-primary-rgb), 0.2);
            text-align: left;
        }
        #anime-episode-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }
        .search-result-item,
        .episode-item {
            background-color: rgba(var(--color-primary-rgb), 0.08);
            border-left: 3px solid var(--color-accent);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all var(--transition-speed-fast) ease;
            font-size: 0.9rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            text-align: left;
        }
        .search-result-item:hover,
        .episode-item:hover,
        .search-result-item:focus,
        .episode-item:focus {
            background-color: rgba(var(--color-primary-rgb), 0.2);
            border-left-color: var(--color-primary);
            transform: translateX(4px);
             outline: none;
             box-shadow: 0 0 5px rgba(var(--color-primary-rgb), 0.3);
        }
        .placeholder-text {
            color: var(--color-text-secondary);
            text-align: center;
            padding: var(--space-sm);
            font-style: italic;
            font-size: 0.9rem;
        }
         .placeholder-text.error {
             color: var(--color-accent);
             font-style: normal;
         }
        #back-to-search-btn {
            padding: var(--space-xs) var(--space-sm);
            background-color: rgba(var(--color-primary-rgb), 0.1);
            border: 1px solid rgba(var(--color-primary-rgb), 0.5);
            color: var(--color-primary);
            font-family: var(--font-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all var(--transition-speed-fast) ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xxs);
            align-self: flex-start;
            margin-top: var(--space-sm);
        }
        #back-to-search-btn ion-icon { font-size: 1.1em; }
        #back-to-search-btn:hover, #back-to-search-btn:focus {
            background-color: var(--color-primary);
            color: var(--color-bg-dark);
            box-shadow: 0 0 8px rgba(var(--color-primary-rgb), 0.4);
            outline: none;
        }

        /* === CSS CHO IFRAME PLAYER CONTAINER === */
        #anime-player-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 800px;
            background-color: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(15px) saturate(190%);
            -webkit-backdrop-filter: blur(15px) saturate(190%);
            border: 1px solid rgba(var(--color-primary-rgb), 0.3);
            border-radius: var(--border-radius-lg);
            padding: var(--space-md);
            z-index: 1000;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            will-change: opacity, transform;
            visibility: hidden;
        }
        #anime-player-container.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            visibility: visible;
        }
        #player-anime-title {
            font-family: var(--font-secondary);
            color: var(--color-primary);
            text-align: center;
            font-size: 1rem;
            margin: 0;
            padding-bottom: var(--space-xs);
            border-bottom: 1px solid rgba(var(--color-primary-rgb), 0.2);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .iframe-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            background-color: #000;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            border: 1px solid rgba(var(--color-primary-rgb), 0.1);
        }
        #anime-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        #close-player-btn {
            position: absolute;
            top: var(--space-xs);
            right: var(--space-xs);
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 2px;
            line-height: 1;
            transition: color var(--transition-speed-fast), transform var(--transition-speed-fast);
            border-radius: 50%;
            z-index: 10;
        }
        #close-player-btn:hover, #close-player-btn:focus {
            color: var(--color-primary);
            transform: rotate(90deg);
             outline: none;
        }

        /* Overlay when player is open */
        body.player-open::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: all; /* Allow click on overlay for closing */
            visibility: hidden;
        }
        body.player-open::after {
            opacity: 1;
            visibility: visible;
        }

        /* === LINKS LIST === */
        #links {
             border-top: 1px solid rgba(var(--color-primary-rgb), 0.15);
            padding-top: var(--space-sm);
             margin-top: var(--space-sm);
         }
        #links ul { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: var(--space-sm); }
        #links li { opacity: 0; transform: translateX(-20px); /* Animation */ }
        #links a { display: block; padding: var(--space-sm) var(--space-md); text-decoration: none; color: var(--color-text-primary); background-color: rgba(var(--color-primary-rgb), 0.1); border: 1px solid rgba(var(--color-primary-rgb), 0.5); border-radius: var(--border-radius-sm); font-weight: 500; transition: all var(--transition-speed-fast) ease-out; position: relative; overflow: hidden; z-index: 1; will-change: transform, background-color, box-shadow; text-align: center; }
        #links a::before { content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(var(--color-primary-rgb), 0.4), transparent); transition: left var(--transition-speed-normal) ease-out; z-index: -1; }
        #links a:hover, #links a:focus { background-color: rgba(var(--color-primary-rgb), 0.25); border-color: var(--color-primary); color: #fff; transform: scale(1.03); box-shadow: 0 0 15px rgba(var(--color-primary-rgb), 0.4); outline: none; }
        #links a:hover::before, #links a:focus::before { left: 100%; }
        #links a:active { transform: scale(0.98); background-color: rgba(var(--color-primary-rgb), 0.3); }

        /* === SOCIAL LINKS === */
        #social-links { display: flex; justify-content: center; gap: var(--space-md); padding-top: var(--space-sm); border-top: 1px solid rgba(255, 255, 255, 0.1); opacity: 0; transform: translateY(20px); /* Animation */ }
        #social-links a { display: inline-flex; align-items: center; justify-content: center; color: var(--color-text-secondary); font-size: 1.6rem; width: 40px; height: 40px; border-radius: var(--border-radius-circle); text-decoration: none; transition: all var(--transition-speed-fast) ease; will-change: transform, color, background-color; }
        #social-links a:hover, #social-links a:focus { color: var(--color-primary); transform: translateY(-3px) scale(1.1); outline: none; background-color: rgba(var(--color-primary-rgb), 0.1); }
        #social-links ion-icon { display: block; }

        /* === FOOTER === */
        footer { margin-top: var(--space-xs); font-size: 0.8rem; color: var(--color-text-secondary); opacity: 0; transform: translateY(20px); /* Animation */ text-align: center; }
        footer a { color: var(--color-accent); text-decoration: none; font-weight: 500; transition: color var(--transition-speed-fast) ease, text-shadow var(--transition-speed-fast) ease; }
        footer a:hover, footer a:focus { color: var(--color-secondary); text-shadow: 0 0 5px var(--color-secondary); outline: none; }

        /* === RESPONSIVENESS === */
        @media (min-width: 500px) { #todo-form { flex-direction: row; align-items: center; } #todo-form input[type="text"] { max-width: none; } #todo-form input[type="time"] { flex-basis: 100px; } #add-todo-btn { align-self: center; } }
        @media (max-width: 768px) { :root { --space-lg: 1.8rem; --space-md: 1.1rem; --space-sm: 0.75rem; } #container { padding: var(--space-md); margin: var(--space-sm); gap: var(--space-sm); } #profile-image-wrapper { width: 90px; height: 90px; } #clock {font-size: 0.8rem;} #audio-player{ padding: var(--space-xs); } #audio-player #track-title { font-size: 0.9rem; } #audio-player .controls {gap: var(--space-sm);} #audio-player .controls button {font-size: 1.5rem;} #audio-player button#play-pause-btn {font-size: 2.2rem;} #social-links { gap: var(--space-sm); } #social-links a { font-size: 1.5rem; width: 38px; height: 38px; } #anime-results-container, #anime-episode-list-container { max-height: 200px;} }
        @media (max-width: 420px) { :root { --space-md: 1rem; --space-sm: 0.65rem; } #profile-image-wrapper { width: 80px; height: 80px; } #clock {letter-spacing: 1px;} #audio-player #track-title {font-size: 0.85rem;} #audio-player .controls {gap: var(--space-xs);} #audio-player .controls button {font-size: 1.4rem; padding: calc(var(--space-xs) / 2);} #audio-player button#play-pause-btn {font-size: 2rem;} #social-links { gap: var(--space-xs); } #social-links a { font-size: 1.4rem; width: 34px; height: 34px; } #links a { padding: var(--space-sm); } #todo-list li { flex-direction: column; align-items: flex-start; } #todo-list .todo-actions { margin-top: var(--space-xs); align-self: flex-end; } #todo-form .todo-input-group { flex-direction: column; } #todo-form input[type="time"] { flex-basis: auto; width: 100%; } #add-todo-btn { width: 100%; margin-top: var(--space-xs); } #anime-results-container, #anime-episode-list-container { max-height: 180px;} .search-result-item, .episode-item { font-size: 0.85rem;} }

        /* === UTILITY CLASSES === */
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

    </style>
</head>
<body>

    <div id="container">
        <div id="profile">
            <div id="profile-image-wrapper">
                <img id="avatar" src="https://niyakipham.github.io/assets/kaguya.jpeg" alt="Ảnh đại diện anime của Niyaki Phạm"/>
            </div>
            <p id="username" data-text="@niyakipham">@niyakipham</p>
            <div id="clock">00:00:00</div>
        </div>

        <!-- /// TO-DO LIST SECTION /// -->
        <section id="todo-section" aria-labelledby="todo-heading">
            <h2 id="todo-heading" class="sci-fi-heading">TO DO LIST</h2>
            <form id="todo-form" aria-label="Thêm nhiệm vụ mới">
                <div class="todo-input-group">
                    <input type="text" id="todo-input" placeholder="Nhiệm vụ mới..." required aria-label="Nội dung nhiệm vụ">
                    <input type="time" id="todo-time" aria-label="Thời gian nhắc nhở" title="Chọn giờ nhắc nhở (trong ngày)">
                </div>
                <button type="submit" id="add-todo-btn" aria-label="Thêm nhiệm vụ">
                    <ion-icon name="add-circle-outline"></ion-icon> ADD
                </button>
            </form>
            <ul id="todo-list" aria-live="polite"><!-- Nhiệm vụ ToDo --></ul>
            <button id="request-permission-btn" style="display: none;" aria-label="Yêu cầu quyền hiển thị thông báo">
                <ion-icon name="notifications-outline"></ion-icon> Cho phép thông báo
            </button>
        </section>
        <!-- /// END TO-DO LIST /// -->

        <!-- /// AUDIO PLAYER (Simplified) /// -->
        <div id="audio-player">
            <div class="track-info">
                 <span id="track-title" title="Đang tải nhạc...">Đang tải nhạc...</span>
                 <div class="progress-container">
                     <div id="progress-bar"></div>
                 </div>
            </div>
             <div class="controls">
                 <div class="main-controls">
                     <button id="prev-btn" aria-label="Bài trước" disabled>
                         <ion-icon name="play-skip-back-outline"></ion-icon>
                    </button>
                     <button id="play-pause-btn" aria-label="Phát nhạc" disabled>
                        <ion-icon name="play-outline"></ion-icon>
                    </button>
                     <button id="next-btn" aria-label="Bài tiếp theo" disabled>
                         <ion-icon name="play-skip-forward-outline"></ion-icon>
                    </button>
                </div>
             </div>
        </div>
        <!-- /// END AUDIO PLAYER /// -->

        <!-- === ANIME SEARCH SECTION === -->
        <section id="anime-search-section" aria-labelledby="anime-search-heading">
            <h2 id="anime-search-heading" class="sci-fi-heading">KHÁM PHÁ ANIME</h2>
            <div id="search-wrapper">
                <input type="search" id="anime-search-input" placeholder="Đang tải data..." aria-label="Nhập tên anime cần tìm" disabled>
                 <button id="search-button" aria-label="Tìm kiếm" disabled><ion-icon name="search-outline"></ion-icon></button>
            </div>
            <div id="anime-results-container" aria-live="polite">
                 <p class="placeholder-text">Đang tải dữ liệu anime...</p>
                <!-- Search results appear here -->
            </div>
            <div id="anime-episode-list-container"> <!-- Hidden by default via CSS -->
                 <h3 id="episode-list-heading" class="sci-fi-heading" style="display: none;">Tên Anime</h3> <!-- Title set by JS -->
                 <ul id="anime-episode-list" aria-live="polite">
                    <!-- Episode list appears here -->
                 </ul>
                <button id="back-to-search-btn" style="display: none;"><ion-icon name="arrow-back-outline"></ion-icon> Quay lại</button>
             </div>
        </section>
        <!-- === END ANIME SEARCH SECTION === -->

        <!-- /// LINKS LIST /// -->
        <nav id="links" aria-label="Liên kết chính">
             <span id="main-content" class="visually-hidden">Nội dung chính</span>
            <ul>
                <li><a href="https://facebook.com/niyakipham" target="_blank" rel="noopener noreferrer">Facebook</a></li>
                <li><a href="https://zalo.me/0901574726" target="_blank" rel="noopener noreferrer">Zalo</a></li>
                <li><a href="https://github.com/niyakipham" target="_blank" rel="noopener noreferrer">Github</a></li>
                <li><a href="https://discordapp.com/users/niyakipham.off" target="_blank" rel="noopener noreferrer">Discord</a></li>
            </ul>
        </nav>
        <!-- /// END LINKS LIST /// -->

        <div id="social-links" aria-label="Liên kết mạng xã hội khác">
            <a href="https://github.com/niyakipham" target="_blank" rel="noopener noreferrer" aria-label="Niyaki Phạm trên Github" title="Github"><ion-icon name="logo-github"></ion-icon></a>
            <a href="https://instagram.com/niyakipham" target="_blank" rel="noopener noreferrer" aria-label="Niyaki Phạm trên Instagram" title="Instagram"><ion-icon name="logo-instagram"></ion-icon></a>
            <a href="https://youtube.com/@Nishimahayashii" target="_blank" rel="noopener noreferrer" aria-label="Niyaki Phạm trên Youtube" title="YouTube"><ion-icon name="logo-youtube"></ion-icon></a>
            <a href="https://www.linkedin.com/in/niyakipham/" target="_blank" rel="noopener noreferrer" aria-label="Niyaki Phạm trên LinkedIn" title="LinkedIn"><ion-icon name="logo-linkedin"></ion-icon></a>
        </div>

        <footer>
             Website được tạo với ❤️ bởi <a href="https://github.com/niyakipham" target="_blank" rel="noopener noreferrer">Niyaki Pham (Phạm Văn Hoàng)</a>
        </footer>

    </div> <!-- End #container -->

     <!-- === IFRAME PLAYER CONTAINER (Placed outside #container for fixed positioning) === -->
     <div id="anime-player-container"> <!-- Hidden by default via CSS -->
         <button id="close-player-btn" aria-label="Đóng trình phát"><ion-icon name="close-circle-outline"></ion-icon></button>
        <h4 id="player-anime-title">Tên Anime - Tập X</h4>
         <div class="iframe-wrapper">
             <iframe id="anime-iframe" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen title="Anime Player"></iframe>
        </div>
     </div>
    <!-- === END IFRAME PLAYER CONTAINER === -->


    <script>
        //********* JAVASCRIPT - VERSION 12.1 (Episode/Grouping Fix) *********//
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const introStaggerDelay = 70;
            const glitchEffectOnLoad = true;
            const glitchDuration = 1500;
             const ANIME_DATA_URL = 'https://raw.githubusercontent.com/niyakipham/data/refs/heads/main/anisub/anidata.csv'; // URL file CSV

            // --- PLAYLIST DATA ---
            const playlist = [
                 { url: 'https://vnno-ne-1-tf-a128-z3.zmdcdn.me/0d6ae249f9f42752b26229ee68df27bc?authen=exp=1744464878~acl=/0d6ae249f9f42752b26229ee68df27bc*~hmac=87943c9019f34f31c68bde4eb0ab0964', title: 'Chill #1 - Lo-fi thư giãn' },
                { url: 'https://vnno-ne-2-tf-a128-z3.zmdcdn.me/1cd3d54ed3dafeb754e40703cc70c623?authen=exp=1744466020~acl=/1cd3d54ed3dafeb754e40703cc70c623*~hmac=791250d3c14d807addf51fac9d7fbea7', title: 'Chuyện đôi ta' },
                { url: 'https://vnno-ne-1-tf-a128-z3.zmdcdn.me/ae3c1c054f7e0e0eb1cc0f1eca8905a6?authen=exp=1744465600~acl=/ae3c1c054f7e0e0eb1cc0f1eca8905a6*~hmac=ac9fbc42b7d3cc6ac36567455acc9799', title: 'Như Anh Đã Thấy Em - PhucXp ft Freak D' },
                { url: 'https://vnno-ne-2-tf-a128-z3.zmdcdn.me/31cb17656c5146f10de0247036f2772d?authen=exp=1744465780~acl=/31cb17656c5146f10de0247036f2772d*~hmac=32781a88701cd9274261c821dacb4812', title: 'Mất Kết Nối ' },
                { url: 'https://vnno-ne-1-tf-a128-z3.zmdcdn.me/90083d6a4f1c62d2b7b5f3e76fed2986?authen=exp=1744466335~acl=/90083d6a4f1c62d2b7b5f3e76fed2986*~hmac=81d70ff5cf594cc82ba5f3f169cb8207', title: 'id 072019 - W/n' }
            ];

            // --- GET DOM ELEMENTS ---
            const container = document.getElementById('container');
            const clockElement = document.getElementById('clock');
            const usernameElement = document.getElementById('username');
            const avatar = document.getElementById('avatar');
            const todoSection = document.getElementById('todo-section');
            const todoForm = document.getElementById('todo-form');
            const todoInput = document.getElementById('todo-input');
            const todoTimeInput = document.getElementById('todo-time');
            const todoListElement = document.getElementById('todo-list');
            const requestPermissionBtn = document.getElementById('request-permission-btn');
            const audioPlayer = document.getElementById('audio-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const playIcon = playPauseBtn?.querySelector('ion-icon');
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = audioPlayer?.querySelector('.progress-container');
            const trackTitleElement = document.getElementById('track-title');
            const mainLinks = document.querySelectorAll('#links a');
            const socialLinksContainer = document.getElementById('social-links');
            const footerElement = document.querySelector('footer');
            // ++ ANIME SEARCH ELEMENTS ++
            const animeSearchSection = document.getElementById('anime-search-section');
            const searchInput = document.getElementById('anime-search-input');
            const searchButton = document.getElementById('search-button');
            const resultsContainer = document.getElementById('anime-results-container');
            const episodeListContainer = document.getElementById('anime-episode-list-container');
            const episodeListHeading = document.getElementById('episode-list-heading');
            const episodeListUl = document.getElementById('anime-episode-list');
            const playerContainer = document.getElementById('anime-player-container');
            const playerIframe = document.getElementById('anime-iframe');
            const playerTitle = document.getElementById('player-anime-title');
            const closePlayerBtn = document.getElementById('close-player-btn');
            const backToSearchBtn = document.getElementById('back-to-search-btn');

            // --- AUDIO PLAYER STATE ---
            let audio = null;
            let currentTrackIndex = 0;
            let isPlaying = false;
            let userHasInteracted = false;
            let playAfterLoad = false;

            // --- TO-DO LIST STATE ---
            let tasks = [];
            let notificationPermission = 'Notification' in window ? Notification.permission : 'unsupported';

            // --- CLOCK STATE ---
            let clockInterval = null;

            // ++ ANIME SEARCH STATE ++
            let allAnimeData = [];
            let currentAnimeEpisodes = [];
            let currentAnimeTitle = '';

            // ============================
            // === HELPER FUNCTIONS ===
            // ============================
             function generateId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 7); }
             function formatTimeForDisplay(date) { if (!date || !(date instanceof Date) || isNaN(date)) return null; try { const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; } catch (e) { console.error("Lỗi định dạng giờ:", e); return null; } }
             function setPrimaryColorRGB() { if (typeof window === 'undefined' || !document?.documentElement) return; try { const style = window.getComputedStyle(document.documentElement); let color = style.getPropertyValue('--color-primary').trim(); let r = 225, g = 29, b = 72; if (color.startsWith('#')) { const hex = color.substring(1); if (hex.length === 3) { r = parseInt(hex[0]+hex[0], 16); g = parseInt(hex[1]+hex[1], 16); b = parseInt(hex[2]+hex[2], 16); } else if (hex.length === 6) { r = parseInt(hex.substring(0,2), 16); g = parseInt(hex.substring(2,4), 16); b = parseInt(hex.substring(4,6), 16); } } else if (color.startsWith('rgb')) { const parts = color.match(/(\d+)/g); if (parts && parts.length >= 3) { r = parseInt(parts[0],10); g = parseInt(parts[1],10); b = parseInt(parts[2],10); } } if (isNaN(r) || isNaN(g) || isNaN(b)) { [r, g, b] = [225, 29, 72]; console.warn("Cannot parse primary color, using default."); } document.documentElement.style.setProperty('--color-primary-rgb', `${r}, ${g}, ${b}`); } catch (e) { console.error("Error setting primary RGB color:", e); document.documentElement.style.setProperty('--color-primary-rgb', `225, 29, 72`); } }

            // Improved CSV Parser
            function parseCSV(csvText) {
                if (!csvText) return [];
                const lines = csvText.trim().split('\n');
                if (lines.length <= 1) return [];

                const header = lines[0].split(',').map(h => h.trim().toLowerCase());
                const data = [];

                const nameIndex = header.indexOf('name');
                const episodesIndex = header.indexOf('episodes');
                const urlIndex = header.indexOf('url'); // Optional

                if (nameIndex === -1 || episodesIndex === -1) {
                    console.error("❌ Critical Error: Could not find 'name' or 'episodes' columns in CSV header. Header found:", header.join(', '));
                    if (resultsContainer) resultsContainer.innerHTML = '<p class="placeholder-text error">Lỗi nghiêm trọng: Không tìm thấy cột tên hoặc tập phim.</p>';
                    return [];
                }

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    try {
                         // This simple split is fragile! Assumes commas only as delimiters
                        const parts = line.split(',');

                        const name = parts[nameIndex]?.trim();
                        const url = (urlIndex !== -1 && parts[urlIndex]) ? parts[urlIndex].trim() : '#';

                        if (!name) continue; // Skip row if essential 'name' is missing

                        // ---- Attempt to extract episode JSON ----
                        let episodeJSONString = '';
                        if (parts[episodesIndex]) { // Check if the part exists
                            episodeJSONString = parts[episodesIndex].trim();
                             // Attempt to handle cases where the JSON string itself might contain commas,
                             // by trying to reconstruct it if it seems broken by the initial split.
                             // This is a VERY basic heuristic and might grab unrelated fields.
                            if (episodeJSONString.startsWith('[') && !episodeJSONString.endsWith(']')) {
                                // Maybe the split broke the JSON array? Try joining subsequent parts.
                                let reconstructed = episodeJSONString;
                                for (let j = episodesIndex + 1; j < parts.length; j++) {
                                    reconstructed += ',' + parts[j];
                                     if (parts[j].includes(']')) { // Crude check for end bracket
                                        // Could check if it's a valid JSON end `]` potentially followed by `"` or `,` or end of line
                                         if (parts[j].match(/\]"?,?$/)) {
                                             episodeJSONString = reconstructed.trim();
                                             // console.log(`Line ${i+1}: Reconstructed episode JSON: ${episodeJSONString.substring(0, 50)}...`);
                                             break; // Stop joining parts
                                         }
                                     }
                                }
                            }

                            // Handle surrounding quotes and escaped quotes "..." -> ... , "" -> "
                             if (episodeJSONString.startsWith('"') && episodeJSONString.endsWith('"')) {
                                 episodeJSONString = episodeJSONString.slice(1, -1).replace(/""/g, '"');
                            }
                        }
                         // ---- End episode extraction ----


                        let episodesData = [];
                        if (episodeJSONString) {
                            try {
                                episodesData = JSON.parse(episodeJSONString);
                                if (!Array.isArray(episodesData)) {
                                    console.warn(`⚠️ Line ${i+1}: Parsed episode data for "${name}" is not an array. Forcing empty. Type: ${typeof episodesData}`);
                                    episodesData = [];
                                }
                            } catch (jsonError) {
                                console.error(`❌ Line ${i+1}: JSON parse error for "${name}". Input approx: "${episodeJSONString.substring(0, 100)}...". Error: ${jsonError.message}`);
                                episodesData = [];
                            }
                        }

                        data.push({ url: url, name: name, episodesData: episodesData });

                    } catch (parseLineError) {
                        console.error(`❌ Error processing CSV line ${i + 1}: "${line.substring(0, 100)}...". Error: ${parseLineError.message}`);
                    }
                }
                console.log(`ℹ️ Parsed ${data.length} raw anime records.`);
                return data;
            }

            // ============================
            // === CLOCK FUNCTIONS ===
            // ============================
            function updateClock() { if (!clockElement) return; try { const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); const seconds = String(now.getSeconds()).padStart(2, '0'); clockElement.textContent = `${hours}:${minutes}:${seconds}`; } catch (e) { console.error("Clock update error:", e); if (clockInterval) clearInterval(clockInterval); } }

            // ============================
            // === AUDIO PLAYER FUNCTIONS ===
            // ============================
            function getTrackTitle(track, index) { if (track.title && String(track.title).trim() !== '') { return String(track.title).trim(); } try { const u = decodeURIComponent(track.url); const f = u.substring(u.lastIndexOf('/') + 1).split('?')[0]; const n = f.replace(/\.(mp3|m4a|ogg|wav)$/i, ''); return n.replace(/[_\+]/g, ' ').trim() || `Track ${index + 1}`; } catch (e) { /*console.warn("Error parsing title from URL:", e);*/ return `Track ${index + 1}`; } }
            function loadTrack(index) { if (typeof Audio === 'undefined'){console.error("Audio not supported");if(trackTitleElement)trackTitleElement.textContent="Not Supported";disableAllControls();return} if (!playlist || index < 0 || index >= playlist.length){console.error("Invalid track index/playlist");if(trackTitleElement)trackTitleElement.textContent=playlist?.length?"Index Error":"Empty Playlist";disableAllControls();return} if(audio){audio.pause();} disableMainControls();isPlaying=false;updatePlayPauseButton(false);if(progressBar)progressBar.style.width='0%'; if(!audio){try{audio=new Audio();audio.preload='metadata';addAudioListeners();}catch(e){console.error("Cannot create Audio:",e);if(trackTitleElement)trackTitleElement.textContent="Player Error";disableAllControls();return}} const track=playlist[index];currentTrackIndex=index;const displayTitle=getTrackTitle(track,index);if(trackTitleElement){trackTitleElement.textContent=displayTitle;trackTitleElement.title=displayTitle} if(audio.src){audio.removeAttribute('src');audio.load();} setTimeout(()=>{try{audio.src=track.url;audio.load();}catch(e){console.error("src/load error:",e);if(trackTitleElement)trackTitleElement.textContent="Track Load Error";disableMainControls()}},50) }
            function updatePrevNextButtonStates() { const canNav = playlist && playlist.length > 1; if(prevBtn) prevBtn.disabled = !canNav; if(nextBtn) nextBtn.disabled = !canNav; }
            function addAudioListeners() { if (!audio) return; audio.addEventListener('timeupdate', ()=>{if (audio.duration&&!isNaN(audio.duration)&&progressBar)progressBar.style.width=`${(audio.currentTime/audio.duration)*100}%`}); audio.addEventListener('ended', handleTrackEnd); audio.addEventListener('error', (e)=>{let m="Player Error";if(audio.error){switch(audio.error.code){case MediaError.MEDIA_ERR_ABORTED:m='Load Aborted';break;case MediaError.MEDIA_ERR_NETWORK:m='Network Error';break;case MediaError.MEDIA_ERR_DECODE:m='Decode Error';break;case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:m='URL/Format Error';break;default:m=`Error ${audio.error.code}`}} else if (e.target?.error){m=`Target Err ${e.target.error.code}`;} console.error("Audio Error Event:",m,e); if(trackTitleElement)trackTitleElement.textContent=m;disableMainControls();updatePlayPauseButton(false);isPlaying=false;playAfterLoad=false}); audio.addEventListener('canplay', ()=>{if(!audio.error){enableMainControls();updatePrevNextButtonStates();if(playAfterLoad){playAfterLoad=false;playAudio()}}else{console.warn("Canplay with error - controls disabled");disableMainControls();updatePrevNextButtonStates()}}); audio.addEventListener('loadstart',()=>{/*console.log(`Load start ${currentTrackIndex}`)*/}); audio.addEventListener('pause', ()=>{if(isPlaying){/*console.log(`External pause ${currentTrackIndex}`)*/;isPlaying=false;updatePlayPauseButton(false);playAfterLoad=false;container?.classList.remove('is-playing')}}); audio.addEventListener('play', ()=>{if(!isPlaying){/*console.log(`External play ${currentTrackIndex}`)*/;isPlaying=true;updatePlayPauseButton(true);container?.classList.add('is-playing')}}); audio.addEventListener('seeking',()=>{/*if (audio.readyState < 2) console.warn('Seeking too early')*/}); }
            function handleTrackEnd() { /*console.log(`Track ${currentTrackIndex} ended`)*/; isPlaying = false; updatePlayPauseButton(false); container?.classList.remove('is-playing'); playNextTrack(true); }
            function togglePlayPause() { if(!audio||!audio.src||playPauseBtn?.disabled) return; if (audio.readyState<1&&!isPlaying){playAfterLoad=true;audio.load();return} if(isPlaying){pauseAudio()} else {playAfterLoad=true;playAudio()} }
            function playAudio() { if (!audio || !audio.src || playPauseBtn?.disabled){playAfterLoad = false;return} if (audio.readyState < 1){audio.load(); playAfterLoad = true;return} const playPromise=audio.play(); if (playPromise !== undefined) { playPromise.then(() => {isPlaying=true; userHasInteracted=true; updatePlayPauseButton(true); container?.classList.add('is-playing'); playAfterLoad=false; }).catch(e => { isPlaying=false; updatePlayPauseButton(false); container?.classList.remove('is-playing'); playAfterLoad=false; console.error(`play() error ${currentTrackIndex}:`, e.name, e.message); if(e.name === 'NotAllowedError'){if(trackTitleElement&&!trackTitleElement.textContent.includes("Click Play"))trackTitleElement.textContent+=" (Click Play)"} else if(e.name==='NotSupportedError'){if(trackTitleElement)trackTitleElement.textContent="Format/Source Error";disableAllControls();} else {if(trackTitleElement)trackTitleElement.textContent=`Play Error: ${e.name}`;disableMainControls();} updatePrevNextButtonStates(); }); } else { isPlaying=true;userHasInteracted=true;updatePlayPauseButton(true);container?.classList.add('is-playing');playAfterLoad=false;} }
            function pauseAudio() { if(!audio) return; audio.pause(); playAfterLoad=false; }
            function playNextTrack(triggeredByEnd = false) { if (!playlist || playlist.length === 0) return; if (playlist.length === 1 && !triggeredByEnd) return; const playNow = isPlaying || triggeredByEnd; const nextIndex = (currentTrackIndex + 1) % playlist.length; if(playNow){playAfterLoad=true} loadTrack(nextIndex); }
            function playPrevTrack() { if (!playlist || playlist.length <= 1) return; const playNow = isPlaying; if (audio && audio.currentTime > 3 && audio.readyState >= 2 && !audio.seeking) { audio.currentTime=0; if (!isPlaying) playAudio(); return; } const prevIndex=(currentTrackIndex-1+playlist.length)%playlist.length; if(playNow){playAfterLoad=true} loadTrack(prevIndex); }
            function updatePlayPauseButton(isPlayingState) { if (!playIcon || !playPauseBtn) return; const iconName=isPlayingState?'pause-outline':'play-outline'; const label=isPlayingState?'Tạm dừng':'Phát'; if(playIcon.getAttribute('name')!==iconName) playIcon.setAttribute('name', iconName); if(playPauseBtn.getAttribute('aria-label')!==label) playPauseBtn.setAttribute('aria-label', label); }
            function enableMainControls() { if(playPauseBtn)playPauseBtn.disabled=false; if(progressContainer)progressContainer.style.cursor='pointer'; }
            function disableMainControls() { if(playPauseBtn)playPauseBtn.disabled=true; if(prevBtn)prevBtn.disabled=true; if(nextBtn)nextBtn.disabled=true; if(progressContainer)progressContainer.style.cursor='default'; }
            function disableAllControls() { disableMainControls(); }
            if (progressContainer) { progressContainer.addEventListener('click', (e)=>{if(!audio||!audio.duration||isNaN(audio.duration)||audio.readyState<1||playPauseBtn?.disabled) return; try{const rect=progressContainer.getBoundingClientRect();if(e.clientX<rect.left||e.clientX>rect.right) return; const r=(e.clientX-rect.left)/progressContainer.offsetWidth; const t=Math.max(0, Math.min(audio.duration, r*audio.duration)); if(!isNaN(t)){audio.currentTime=t;if(progressBar)progressBar.style.width=`${(t/audio.duration)*100}%`}} catch(err){console.error("Seek error:",err)}}); }

            // ============================
            // === TO-DO LIST FUNCTIONS ===
            // ============================
            function scheduleNotification(task) { if(!task.notifyTime||task.completed||!(task.notifyTime instanceof Date)||isNaN(task.notifyTime)) return; const n=Date.now(); const ts=task.notifyTime.getTime(); const d=ts-n; if(task.timeoutId){clearTimeout(task.timeoutId);task.timeoutId=null;} if(d>0&&notificationPermission==='granted'){task.timeoutId=setTimeout(()=>{showNotification(task);const ct=tasks.find(t=>t.id===task.id);if(ct){ct.timeoutId=null;saveTasks();renderTasks();}}, d);} else {task.timeoutId=null;} }
            function showNotification(task) { if(notificationPermission!=='granted')return; try {const N=new Notification('📅 Việc cần làm!',{body:task.text,icon:'https://niyakipham.github.io/assets/kaguya.jpeg',tag:task.id,renotify:true});N.onclick=()=>{window.focus();const el=todoListElement?.querySelector(`li[data-id="${task.id}"]`);if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.backgroundColor='rgba(var(--color-primary-rgb),0.2)';setTimeout(()=>{el.style.backgroundColor=''},1500);}};N.onerror=(err)=>console.error('Notif API err:',err);}catch(err){console.error('Show notif err:',err);} }
            function renderTask(task) { const li=document.createElement('li');li.dataset.id=task.id;li.className=task.completed?'completed':'';li.style.opacity='0';li.style.transform='translateX(-10px)';const cd=document.createElement('div');cd.className='todo-content';const ts=document.createElement('span');ts.className='todo-text';ts.textContent=task.text;cd.appendChild(ts);const dt=formatTimeForDisplay(task.notifyTime);if(dt){const tid=document.createElement('div');tid.className='todo-time-info';const ti=document.createElement('ion-icon');ti.setAttribute('name','alarm-outline');ti.setAttribute('aria-hidden','true');tid.appendChild(ti);const tisp=document.createElement('span');const today=new Date();const tmrw=new Date(today);tmrw.setDate(today.getDate()+1);let pfx='';if(task.notifyTime?.toDateString()===today.toDateString())pfx='H.nay ';else if(task.notifyTime?.toDateString()===tmrw.toDateString())pfx='N.mai ';tisp.textContent=pfx+dt;tisp.setAttribute('aria-label',`Nhắc lúc: ${pfx}${dt}`);tid.appendChild(tisp);if(task.notifyTime&&task.notifyTime.getTime()<Date.now()&&task.timeoutId===null&&!task.completed){const di=document.createElement('ion-icon');di.setAttribute('name','checkmark-done-outline');di.setAttribute('aria-hidden','true');di.title='Đã qua giờ';tid.appendChild(di);}cd.appendChild(tid);}li.appendChild(cd);const ad=document.createElement('div');ad.className='todo-actions';const cb=document.createElement('button');cb.className='complete-btn';const cl=task.completed?'Chưa xong':'Hoàn thành';cb.setAttribute('aria-label',cl);cb.title=cl;const ci=document.createElement('ion-icon');ci.setAttribute('name',task.completed?'refresh-outline':'checkmark-circle-outline');ci.setAttribute('aria-hidden','true');cb.appendChild(ci);cb.addEventListener('click',()=>toggleCompleteTask(task.id));ad.appendChild(cb);const db=document.createElement('button');db.className='delete-btn';db.setAttribute('aria-label','Xóa');db.title='Xóa';const di=document.createElement('ion-icon');di.setAttribute('name','trash-outline');di.setAttribute('aria-hidden','true');db.appendChild(di);db.addEventListener('click',()=>deleteTask(task.id));ad.appendChild(db);li.appendChild(ad);requestAnimationFrame(()=>{li.style.opacity='1';li.style.transform='translateX(0)';});return li; }
            function renderTasks() { if(!todoListElement)return;tasks.forEach(task=>{if(task.timeoutId)clearTimeout(task.timeoutId);task.timeoutId=null;});const frag=document.createDocumentFragment();if(tasks.length===0){const el=document.createElement('li');el.textContent='Chưa có việc nào...';el.style.cssText='justify-content:center;opacity:0.6;border-left:none;padding:var(--space-sm);';frag.appendChild(el);}else{tasks.forEach(task=>frag.appendChild(renderTask(task)));}todoListElement.innerHTML='';todoListElement.appendChild(frag);tasks.forEach(task=>{if(!task.completed&&task.notifyTime&&task.notifyTime.getTime()>Date.now()&&!task.timeoutId)scheduleNotification(task);});checkNotificationPermission(tasks.some(t=>t.notifyTime&&!t.completed));}
            function saveTasks() { if(!window.localStorage)return;try{const tts=tasks.map(t=>({...t,notifyTime:t.notifyTime?.toISOString()||null,timeoutId:null}));localStorage.setItem('niyakiTasks_v2',JSON.stringify(tts));}catch(e){console.error("Save task error:",e);if(e.name==='QuotaExceededError')alert('LocalStorage full!');}}
            function loadTasks() { if(!window.localStorage){tasks=[];renderTasks();return;}const saved=localStorage.getItem('niyakiTasks_v2');if(saved){try{tasks=JSON.parse(saved).map(t=>({...t,notifyTime:t.notifyTime?new Date(t.notifyTime):null,timeoutId:null})).filter(t=>t.id&&t.text);}catch(e){console.error("Load/Parse task error:",e);localStorage.removeItem('niyakiTasks_v2');tasks=[];}}else{tasks=[];}renderTasks();}
            function addTask(event) { event.preventDefault();const text=todoInput.value.trim();const timeStr=todoTimeInput.value;if(!text){alert('Nhập nhiệm vụ!');todoInput.focus();return;}let nt=null;if(timeStr){const[h,m]=timeStr.split(':').map(Number);if(!isNaN(h)&&!isNaN(m)){nt=new Date();nt.setHours(h,m,0,0);if(nt<=Date.now())nt.setDate(nt.getDate()+1);}else{alert('Giờ không hợp lệ!');todoTimeInput.focus();return;}}const newTask={id:generateId(),text:text,notifyTime:nt,completed:false,timeoutId:null};tasks.unshift(newTask);saveTasks();renderTasks();todoInput.value='';todoTimeInput.value='';todoInput.focus();}
            function deleteTask(id) { const idx=tasks.findIndex(t=>t.id===id);if(idx>-1){const task=tasks[idx];if(task.timeoutId)clearTimeout(task.timeoutId);const el=todoListElement?.querySelector(`li[data-id="${id}"]`);if(el){el.style.opacity='0';el.style.transform='translateX(20px)';el.addEventListener('transitionend',()=>{if(el.parentNode)el.remove();if(tasks.some(t=>t.id===id)){tasks.splice(idx,1);saveTasks();if(tasks.length===0)renderTasks();}},{once:true});}else{tasks.splice(idx,1);saveTasks();renderTasks();}}}
            function toggleCompleteTask(id) { const idx=tasks.findIndex(t=>t.id===id);if(idx>-1){const task=tasks[idx];task.completed=!task.completed;if(task.completed&&task.timeoutId){clearTimeout(task.timeoutId);task.timeoutId=null;}else if(!task.completed&&task.notifyTime&&task.notifyTime>Date.now()&&!task.timeoutId){scheduleNotification(task);}saveTasks();renderTasks();}}
            function checkNotificationPermission(showBtnIfNeeded=false){if(notificationPermission==='unsupported'||!('Notification'in window)){if(requestPermissionBtn)requestPermissionBtn.style.display='none';return;}notificationPermission=Notification.permission;if(requestPermissionBtn){if(notificationPermission==='granted'){requestPermissionBtn.style.display='none';tasks.forEach(task=>{if(!task.completed&&task.notifyTime&&task.notifyTime>Date.now()&&!task.timeoutId)scheduleNotification(task);});}else if(notificationPermission==='denied'){requestPermissionBtn.style.display='none';}else{requestPermissionBtn.style.display=showBtnIfNeeded?'inline-flex':'none';}}}
            function handleRequestPermission(){if(notificationPermission==='unsupported'||!('Notification'in window)||Notification.permission!=='default'){checkNotificationPermission(false);return;}Notification.requestPermission().then(perm=>{notificationPermission=perm;checkNotificationPermission(false);if(perm==='granted'){new Notification('Đã cấp quyền!',{body:'Bạn sẽ nhận được thông báo.',icon:'https://niyakipham.github.io/assets/kaguya.jpeg'});renderTasks();}else{alert('Bạn không cấp quyền, nhắc nhở sẽ không hiển thị.');}}).catch(err=>console.error("Permission request error:",err));}


            // ============================
            // === ANIME SEARCH FUNCTIONS ===
            // ============================

            // --- Fetch and Parse Anime Data ---
            async function loadAnimeData() {
                console.log("⏳ Loading anime data...");
                if (resultsContainer) resultsContainer.innerHTML = '<p class="placeholder-text">Đang tải dữ liệu anime...</p>';
                if (searchInput) {
                     searchInput.placeholder = "Đang tải data...";
                     searchInput.disabled = true;
                }
                if (searchButton) searchButton.disabled = true;

                try {
                    const response = await fetch(ANIME_DATA_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const csvText = await response.text();
                    allAnimeData = parseCSV(csvText);

                    if (allAnimeData.length > 0) {
                        console.log("✅ Anime data loaded successfully.");
                        if (resultsContainer) resultsContainer.innerHTML = '<p class="placeholder-text">Nhập tên anime bạn muốn tìm...</p>';
                        if (searchInput) {
                            searchInput.placeholder = "Tìm kiếm anime...";
                            searchInput.disabled = false;
                        }
                        if (searchButton) searchButton.disabled = false;
                    } else {
                        console.warn("⚠️ No valid anime data parsed. Check CSV format and content.");
                        if (resultsContainer) resultsContainer.innerHTML = '<p class="placeholder-text error">Không có dữ liệu anime hợp lệ.</p>';
                        if (searchInput) searchInput.placeholder = "Lỗi tải data";
                    }
                } catch (error) {
                    console.error("❌ Error loading/parsing anime data:", error);
                    if (resultsContainer) resultsContainer.innerHTML = `<p class="placeholder-text error">Lỗi tải dữ liệu. Vui lòng thử lại.</p>`;
                    if (searchInput) {
                        searchInput.placeholder = "Lỗi tải data";
                        searchInput.disabled = true;
                    }
                     if (searchButton) searchButton.disabled = true;
                 }
            }

            // --- Render UNIQUE Search Results ---
            function renderSearchResults(uniqueResults) {
                if (!resultsContainer) return;
                resultsContainer.innerHTML = '';

                if (uniqueResults.length === 0) {
                    if (searchInput && searchInput.value.trim()) {
                        resultsContainer.innerHTML = '<p class="placeholder-text">Không tìm thấy anime nào khớp.</p>';
                     } else {
                         resultsContainer.innerHTML = '<p class="placeholder-text">Nhập tên anime bạn muốn tìm...</p>';
                    }
                    return;
                 }

                const fragment = document.createDocumentFragment();
                uniqueResults.forEach(anime => {
                    const originalAnimeData = allAnimeData.find(orig => orig.name === anime.name);
                    if (!originalAnimeData) return; // Should not happen if uniqueResults came from allAnimeData

                    const item = document.createElement('div');
                    item.classList.add('search-result-item');
                    item.textContent = anime.name;
                    item.title = anime.name;
                    item.dataset.animeName = anime.name;
                    item.setAttribute('role', 'button');
                    item.tabIndex = 0;
                    item.addEventListener('click', () => handleAnimeSelect(anime.name));
                    item.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleAnimeSelect(anime.name); }
                    });
                    fragment.appendChild(item);
                });
                resultsContainer.appendChild(fragment);
                resultsContainer.style.display = 'block';
                if (episodeListContainer) episodeListContainer.style.display = 'none';
            }

            // --- Handle Search Input (Groups results) ---
             function handleSearch() {
                if (!searchInput) return;
                const searchTerm = searchInput.value.trim().toLowerCase();

                 if (!allAnimeData || allAnimeData.length === 0) {
                    if (resultsContainer && searchTerm) {
                        resultsContainer.innerHTML = '<p class="placeholder-text error">Dữ liệu chưa sẵn sàng.</p>';
                     } else if (resultsContainer) {
                         resultsContainer.innerHTML = '<p class="placeholder-text">Nhập tên anime bạn muốn tìm...</p>';
                    }
                    return;
                 }

                if (!searchTerm) {
                     if (resultsContainer) resultsContainer.innerHTML = '<p class="placeholder-text">Nhập tên anime bạn muốn tìm...</p>';
                    if (episodeListContainer) episodeListContainer.style.display = 'none';
                    return;
                 }

                const filteredAnime = allAnimeData.filter(anime =>
                    anime.name && anime.name.toLowerCase().includes(searchTerm)
                );

                const groupedResults = new Map();
                filteredAnime.forEach(anime => {
                    if (!groupedResults.has(anime.name)) {
                        groupedResults.set(anime.name, anime);
                    }
                });
                const uniqueAnimeResults = Array.from(groupedResults.values());

                 console.log(`Found ${filteredAnime.length} matches, ${uniqueAnimeResults.length} unique results for "${searchTerm}"`);
                 renderSearchResults(uniqueAnimeResults);
             }

             // --- Handle Selecting an Anime from Results ---
            function handleAnimeSelect(animeName) {
                const selectedAnime = allAnimeData.find(anime => anime.name === animeName);

                if (!selectedAnime) {
                    console.error(`❌ Cannot find data for selected anime: "${animeName}"`);
                     alert(`Lỗi: Không tìm thấy dữ liệu chi tiết cho ${animeName}.`);
                    return;
                }

                console.log(`✅ Selected: "${selectedAnime.name}". Preparing episodes.`);
                currentAnimeTitle = selectedAnime.name;
                const episodesRoot = selectedAnime.episodesData;

                // Reset current episodes before processing
                currentAnimeEpisodes = [];

                if (!episodesRoot || !Array.isArray(episodesRoot)) {
                     console.warn(`⚠️ No 'episodesData' array for "${animeName}". Raw:`, episodesRoot);
                } else if (episodesRoot.length === 0) {
                     console.warn(`⚠️ 'episodesData' is empty for "${animeName}".`);
                 } else {
                    const firstServer = episodesRoot[0];
                     if (!firstServer || !firstServer.server_data || !Array.isArray(firstServer.server_data)) {
                         console.warn(`⚠️ Invalid server_data structure for "${animeName}". Server entry:`, firstServer);
                    } else {
                         // Assign episodes if structure is valid
                         currentAnimeEpisodes = firstServer.server_data;
                         console.log(`🎞️ Found ${currentAnimeEpisodes.length} episodes in first server for "${animeName}".`);
                     }
                }

                renderEpisodeList(currentAnimeEpisodes); // Render even if empty

                if (resultsContainer) resultsContainer.style.display = 'none';
                if (episodeListContainer) episodeListContainer.style.display = 'flex';
                if (episodeListHeading) {
                    episodeListHeading.textContent = `${currentAnimeTitle}`; // Set heading to anime name
                    episodeListHeading.style.display = 'block';
                 }
                if (backToSearchBtn) backToSearchBtn.style.display = 'inline-flex';
                if (episodeListContainer) episodeListContainer.scrollTop = 0;
             }

            // --- Render Episode List ---
            function renderEpisodeList(episodes) {
                if (!episodeListUl) return;
                episodeListUl.innerHTML = '';

                if (!episodes || episodes.length === 0) {
                     console.log("📋 No episodes to display.");
                     // Add placeholder directly inside UL for consistency
                    episodeListUl.innerHTML = '<li class="placeholder-text" style="border: none; background: none; text-align: center; width: 100%;">Không có thông tin tập.</li>';
                     return;
                 }

                 const fragment = document.createDocumentFragment();
                 let validEpisodeCount = 0;
                 episodes.forEach((ep) => {
                     if (!ep || typeof ep.name !== 'string' || !ep.name.trim() || typeof ep.link_embed !== 'string' || !ep.link_embed.trim()) {
                         console.warn("Skipping invalid episode entry:", ep);
                         return;
                     }

                    const episodeName = ep.name.trim();
                    const embedLink = ep.link_embed.trim();

                    const item = document.createElement('li');
                    item.classList.add('episode-item');
                    item.textContent = episodeName;
                    item.title = episodeName;
                     item.dataset.embedLink = embedLink;
                     item.dataset.episodeName = episodeName;
                    item.setAttribute('role', 'button');
                    item.tabIndex = 0;
                    item.addEventListener('click', () => handleEpisodeSelect(embedLink, episodeName));
                    item.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleEpisodeSelect(embedLink, episodeName); }
                    });
                     fragment.appendChild(item);
                     validEpisodeCount++;
                 });

                 if (validEpisodeCount === 0) {
                     console.log("📋 No *valid* episodes found after filtering.");
                     episodeListUl.innerHTML = '<li class="placeholder-text" style="border: none; background: none; text-align: center; width: 100%;">Không tìm thấy tập hợp lệ.</li>';
                } else {
                     episodeListUl.appendChild(fragment);
                 }
             }

             // --- Handle Selecting an Episode to Watch ---
            function handleEpisodeSelect(embedLink, episodeName) {
                console.log(`▶️ Watching: "${currentAnimeTitle} - ${episodeName}"`);
                if (!playerContainer || !playerIframe || !playerTitle || !closePlayerBtn) return;

                playerTitle.textContent = `${currentAnimeTitle} - ${episodeName}`;
                playerIframe.src = embedLink;

                 playerContainer.style.display = 'flex';
                requestAnimationFrame(() => {
                    playerContainer.classList.add('visible');
                    document.body.classList.add('player-open');
                 });
                closePlayerBtn.focus();
            }

             // --- Close the Video Player ---
            function closePlayer() {
                 if (!playerContainer || !playerIframe || !playerContainer.classList.contains('visible')) return; // Add check if already closing/closed
                 playerContainer.classList.remove('visible');
                document.body.classList.remove('player-open');
                playerIframe.src = '';

                const resetDisplay = () => {
                     if (!playerContainer.classList.contains('visible')) { // Double check visibility flag
                         playerContainer.style.display = ''; // Let CSS handle display via visibility
                     }
                     playerContainer.removeEventListener('transitionend', resetDisplay);
                 };
                playerContainer.addEventListener('transitionend', resetDisplay);

                // Fallback timer
                setTimeout(() => {
                    if (!playerContainer.classList.contains('visible')) { playerContainer.style.display = ''; }
                    playerContainer.removeEventListener('transitionend', resetDisplay);
                 }, 400);
            }

            // --- Go Back to Search Results ---
             function goBackToSearch() {
                 if (resultsContainer) resultsContainer.style.display = 'block';
                if (episodeListContainer) episodeListContainer.style.display = 'none';
                if (backToSearchBtn) backToSearchBtn.style.display = 'none';
                 if (searchInput) {
                     searchInput.focus();
                     handleSearch(); // Refresh search results based on current input value
                 }
             }

            // ============================
            // === INITIALIZATION ===
            // ============================
            console.log("🚀 Init Profile v12.1 (Episode/Grouping Fix)... ✨");
            setPrimaryColorRGB();
            if (clockElement) { updateClock(); clockInterval = setInterval(updateClock, 1000); }
            loadTasks(); // Load ToDo Tasks

            // --- Initialize Audio Player ---
             if (playlist && playlist.length > 0) {
                 if(playPauseBtn) playPauseBtn.addEventListener('click', togglePlayPause);
                 if(nextBtn) nextBtn.addEventListener('click', () => playNextTrack(false));
                 if(prevBtn) prevBtn.addEventListener('click', playPrevTrack);
                 playAfterLoad = true;
                 loadTrack(0);
             } else {
                 console.warn("Audio playlist empty."); if (trackTitleElement) trackTitleElement.textContent = "Playlist trống"; disableAllControls();
            }

             // --- Initialize Anime Search ---
            loadAnimeData(); // Load Anime data early
            if (searchInput) {
                 searchInput.addEventListener('input', handleSearch);
                 searchInput.addEventListener('keydown', (e) => { if(e.key === 'Enter'){e.preventDefault(); handleSearch();} });
             }
            if (searchButton) {
                 searchButton.addEventListener('click', () => { if(searchInput) searchInput.focus(); handleSearch(); });
             }
             if (closePlayerBtn) { closePlayerBtn.addEventListener('click', closePlayer); }
             // Event listener for overlay click (body::after) needs to be on a parent or document
             document.addEventListener('click', (e) => {
                // Check if the click was directly on the body's ::after pseudo-element overlay area
                // We can check if the body has player-open and the click was NOT inside the player itself
                if (document.body.classList.contains('player-open') && playerContainer && !playerContainer.contains(e.target) ) {
                     // Also make sure the click wasn't on something that opened the player (like an episode item)
                    if (!e.target.closest('.episode-item')) {
                         closePlayer();
                    }
                 }
            });
            document.addEventListener('keydown', (e) => { if(e.key === 'Escape' && playerContainer?.classList.contains('visible')) { closePlayer(); } });
             if (backToSearchBtn) { backToSearchBtn.addEventListener('click', goBackToSearch); }

             // ToDo Listeners
            if (todoForm) todoForm.addEventListener('submit', addTask);
            if (requestPermissionBtn) requestPermissionBtn.addEventListener('click', handleRequestPermission);

            // --- Entrance Animations ---
             try {
                 if (typeof anime !== 'undefined') {
                     const tl = anime.timeline({ easing: 'easeOutExpo', duration: 800 });
                     tl.add({ targets: '#container', opacity: [0, 1], translateY: [20, 0], duration: 600 })
                        .add({ targets: ['#profile-image-wrapper', '#profile p#username'], opacity: [0, 1], scale: [0.8, 1], duration: 600 }, '-=450')
                        .add({ targets: '#clock', opacity: [0, 1], translateY: [10, 0], duration: 400 }, '-=450')
                        .add({ targets: '#todo-section', opacity: [0, 1], translateY: [20, 0], duration: 500 }, '-=350')
                         .add({ targets: '#todo-list li', opacity: [0, 1], translateX: [-10, 0], delay: anime.stagger(50) }, '-=400') // Animate Todo Items
                        .add({ targets: '#audio-player', opacity: [0, 1], translateY: [10, 0], duration: 500 }, '-=700') // Adjust timing relative to Todo List Items
                        .add({ targets: '#anime-search-section', opacity: [0, 1], translateY: [20, 0], duration: 500 }, '-=400')
                        .add({ targets: '#links li', opacity: [0, 1], translateX: [-20, 0], delay: anime.stagger(introStaggerDelay) }, '-=400')
                        .add({ targets: ['#social-links', 'footer'], opacity: [0, 1], translateY: [20, 0], duration: 500 }, '-=400');

                     if (glitchEffectOnLoad && usernameElement) { tl.add({ targets: usernameElement, duration: 1, begin: () => { usernameElement.classList.add('glitch-text'); setTimeout(() => { usernameElement?.classList.remove('glitch-text'); }, glitchDuration); } }, '-=300'); }
                 } else {
                    console.warn("Anime.js not found, skipping animations.");
                     document.querySelectorAll('#container, #profile-image-wrapper, #profile p#username, #clock, #todo-section, #audio-player, #anime-search-section, #links li, #social-links, footer, #todo-list li').forEach(el => { el.style.opacity = 1; el.style.transform = 'none'; });
                 }
             } catch (error) {
                 console.error("Animation init error:", error);
                 document.querySelectorAll('#container, #profile-image-wrapper, #profile p#username, #clock, #todo-section, #audio-player, #anime-search-section, #links li, #social-links, footer, #todo-list li').forEach(el => { el.style.opacity = 1; el.style.transform = 'none'; });
             }

            // --- Hover Animations ---
            if (avatar) { avatar.addEventListener('mouseenter',()=>anime({targets:avatar,scale:1.08,rotate:4,duration:300,easing:'easeOutBack'})); avatar.addEventListener('mouseleave',()=>anime({targets:avatar,scale:1,rotate:0,duration:400,easing:'easeOutQuad'})); }
             Array.from(socialLinksContainer?.querySelectorAll('a')||[]).forEach(link => { link.addEventListener('mouseenter',()=>anime({targets:link,translateY:-4,scale:1.15,duration:250,easing:'easeOutBack'})); link.addEventListener('mouseleave',()=>anime({targets:link,translateY:0,scale:1,duration:350,easing:'easeOutQuad'})); });


             console.log("✅ Initialization complete. Profile v12.1 is ready!");
            if (typeof anime !== 'undefined') console.log("ℹ️ Anime.js v:", anime.version);

        }); // --- DOMContentLoaded End ---
    </script>

</body>
</html>
